<div class="flex h-screen flex-col">
    <app-sidenav (navToggled)="onNavToggled($event)" class="fixed top-0 left-0 h-full z-10"></app-sidenav>
    <app-navbar class="relative z-20"></app-navbar>
    <div class="content-area">
        <div class="dashboard-container">
            <div class="transition-all duration-300 z-1 mt-16" [class.lg:ml-64]="isNavOpen"
                [class.lg:ml-20]="!isNavOpen">
                <!-- Main Content -->
                <div class="p-4">
                    <!-- Header -->
                    <div class="mb-4 p-2">
                        <h1 class="text-xl">Community Events</h1>
                    </div>

                    <!-- Main content -->
                    <div class="flex-1 p-6">
                        <!-- Header with buttons -->
                        <div class="flex flex-col md:flex-row items-center justify-between mb-6">
                            <button (click)="openAddModal()"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 mb-2 md:mb-0">
                                <i class="fas fa-plus"></i> Create Event
                            </button>
                            <div class="flex flex-col md:flex-row items-center gap-4">
                                <!-- <button class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-calendar-alt"></i> Export Calendar
                    </button> -->
                                <input type="text" [(ngModel)]="searchTerm" (input)="filterEvents()"
                                    class="border rounded-lg px-4 py-2 w-full md:w-64" placeholder="Search events...">
                                <button (click)="showFilterOptions = !showFilterOptions"
                                    class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg flex items-center gap-2">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div (click)="openUpcomingEventsModal()"
                                class="bg-white rounded-xl p-6 shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50">
                                <div>
                                    <div class="text-gray-500 text-sm">Upcoming Events</div>
                                    <div class="text-2xl font-semibold">{{stats.upcoming_events}}</div>
                                </div>
                                <div class="bg-blue-100 p-4 rounded-full text-blue-500">
                                    <i class="fas fa-calendar text-xl"></i>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-6 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="text-gray-500 text-sm">Total Attendees</div>
                                    <div class="text-2xl font-semibold">{{stats.total_attendees}}</div>
                                </div>
                                <div class="bg-green-100 p-4 rounded-full text-green-500">
                                    <i class="fas fa-users text-xl"></i>
                                </div>
                            </div>
                            <div (click)="openCompletedEventsModal()"
                                class="bg-white rounded-xl p-6 shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50">
                                <div>
                                    <div class="text-gray-500 text-sm">Completed Events</div>
                                    <div class="text-2xl font-semibold">{{stats.completed_events}}</div>
                                </div>
                                <div class="bg-purple-100 p-4 rounded-full text-purple-500">
                                    <i class="fas fa-check-circle text-xl"></i>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl p-6 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="text-gray-500 text-sm">Pending Events</div>
                                    <div class="text-2xl font-semibold">{{stats.pending_events}}</div>
                                </div>
                                <div class="bg-orange-100 p-4 rounded-full text-orange-500">
                                    <i class="fas fa-clock text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Navigation -->
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Events Calendar - {{currentMonth}} {{currentYear}}</h2>
                            <div class="flex gap-2">
                                <button (click)="previousMonth()" class="p-2 rounded hover:bg-gray-100">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button (click)="nextMonth()" class="p-2 rounded hover:bg-gray-100">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Events Grid -->
                        <div *ngIf="isLoading" class="flex justify-center items-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        </div>

                        <div *ngIf="!isLoading && filteredEvents.length === 0" class="text-center py-8 text-gray-500">
                            No events found
                        </div>

                        <div *ngIf="!isLoading && filteredEvents.length > 0"
                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div *ngFor="let event of filteredEvents"
                                class="bg-white rounded-xl shadow-sm overflow-hidden">
                                <img [src]="event.image" alt="Event image" class="w-full h-48 object-cover">
                                <div class="p-6">
                                    <h3 class="text-lg font-semibold mb-2">{{event.title}}</h3>
                                    <div class="flex items-center gap-2 text-gray-600 mb-2">
                                        <i class="far fa-calendar"></i>
                                        <span>{{event.date | date}}</span>
                                    </div>

                                    <div class="flex items-center gap-2 text-gray-600 mb-2">
                                        <i class="fa-regular fa-clock"></i>
                                        <span>
                                            {{ event.date + ' ' + event.time | date:'shortTime' }} -
                                            {{ event.date + ' ' + event.end_time | date:'shortTime' }}
                                            ({{ event.duration }})
                                        </span>
                                    </div>

                                    <div class="flex items-center gap-2 text-gray-600 mb-2">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{event.location}}</span>
                                    </div>

                                    <div class="flex justify-between items-center">
                                        <span [ngClass]="{
                                'px-3 py-1 rounded-full text-sm': true,
                                'bg-blue-100 text-blue-600': event.status === 'Upcoming',
                                'bg-green-100 text-green-600': event.status === 'Completed',
                                'bg-yellow-100 text-yellow-600': event.status === 'Pending'
                            }">{{event.status}}</span>
                                        <div class="flex gap-2">
                                            <button class="p-2 text-blue-500 hover:bg-blue-50 rounded"
                                                (click)="openEditModal(event)">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="p-2 text-red-500 hover:bg-red-50 rounded"
                                                (click)="deleteEvent(event.id!)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Add Event Modal -->
            <div *ngIf="showAddModal" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form #eventForm="ngForm" enctype="multipart/form-data" (ngSubmit)="createEvent()">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-medium text-gray-900">Create New Event</h3>
                                    <button type="button" (click)="closeAddModal()"
                                        class="text-gray-400 hover:text-gray-500">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" [(ngModel)]="newEvent.title" name="title" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <p *ngIf="duplicateError" class="mt-1 text-sm text-red-600">{{duplicateError}}
                                        </p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Description</label>
                                        <textarea [(ngModel)]="newEvent.description" name="description" required
                                            rows="3"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                                    </div>
                                    <div class="grid grid-cols-3 gap-4">

                                        <div>
                                            <!-- // ADDED FOR DATE NOT SELECTING PASTS AND CURRENT DATES " Line 174" -->
                                            <label class="block text-sm font-medium text-gray-700">Date</label>
                                            <input type="date" [(ngModel)]="newEvent.date" name="date" required
                                                [min]="getMinDate()"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                            <p *ngIf="dateError" class="mt-1 text-sm text-red-600">{{dateError}}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Start Time</label>
                                            <select 
                                                [(ngModel)]="newEvent.time" 
                                                name="Start time"
                                                (ngModelChange)="updateEndTimeOptions()"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">Start Time</option>
                                                <option *ngFor="let time of timeOptions" [value]="time">{{ time }}</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">End Time</label>
                                            <select 
                                                [(ngModel)]="newEvent.end_time" 
                                                name="End time"
                                                [disabled]="!newEvent.time"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">End Time</option>
                                                <option *ngFor="let time of endTimeOptions" [value]="time">{{ time }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Location</label>
                                    <input type="text" [(ngModel)]="newEvent.location" name="location" required
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Event Image</label>
                                    <input type="file" (change)="onImageSelect($event)" accept="image/*"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <p class="mt-1 text-sm text-gray-500">Maximum size: 5MB. Supported formats: JPG,
                                        PNG, GIF</p>
                                    <div *ngIf="imagePreview" class="mt-2">
                                        <img [src]="imagePreview" alt="Preview" class="h-32 w-32 object-cover rounded">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="submit" [disabled]="!eventForm.form.valid || isSubmitting"
                                    [class.opacity-50]="!eventForm.form.valid || isSubmitting"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                    <span *ngIf="isSubmitting" class="mr-2">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                    </span>
                                    {{ isSubmitting ? 'Creating...' : 'Create Event' }}

                                </button>
                                <button type="button" (click)="closeAddModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Success Message -->
            <div *ngIf="showSuccessMessage"
                class="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 flex items-center shadow-lg">
                <svg class="fill-current h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20">
                    <path
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
                </svg>
                <p class="font-medium">Event created successfully!</p>
            </div>

            <!-- Add Edit Modal -->
            <div *ngIf="showEditModal" class="fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                    <div
                        class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <form #editForm="ngForm">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Event</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" [(ngModel)]="editingEvent!.title" name="title" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Description</label>
                                        <textarea [(ngModel)]="editingEvent!.description" name="description" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Date</label>
                                            <input type="date" [(ngModel)]="editingEvent!.date" name="date" required
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Time</label>
                                            <input type="time" [(ngModel)]="editingEvent!.time" name="time" required
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Location</label>
                                        <input type="text" [(ngModel)]="editingEvent!.location" name="location" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    <!-- <div>
                            <label class="block text-sm font-medium text-gray-700">Expected Attendees</label>
                            <input type="number" [(ngModel)]="editingEvent!.attendees" name="attendees" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div> -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Event Image</label>
                                        <input type="file" (change)="onImageSelect($event)" accept="image/*"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <img *ngIf="imagePreview" [src]="imagePreview"
                                            class="mt-2 h-32 w-full object-cover rounded">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="button" (click)="updateEvent()" [disabled]="!editForm.form.valid"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                                    Update Event
                                </button>
                                <button type="button" (click)="closeEditModal()"
                                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events Modal -->
            <div *ngIf="showUpcomingEventsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <!-- Modal Header -->
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <h2 class="text-xl font-semibold">Upcoming Events</h2>
                        <button (click)="closeUpcomingEventsModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Modal Content -->
                    <div class="p-6">
                        <div class="grid gap-4">
                            <div *ngFor="let event of upcomingEvents" 
                                 class="bg-white rounded-lg border p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-center gap-4">
                                    <img [src]="event.image" 
                                         [alt]="event.title"
                                         class="w-16 h-16 object-cover rounded">
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-lg">{{event.title}}</h3>
                                        <div class="flex items-center gap-2 text-gray-600">
                                            <i class="fa-regular fa-calendar"></i>
                                            <span>{{event.date | date:'mediumDate'}}</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-gray-600">
                                            <i class="fa-regular fa-clock"></i>
                                            <span>
                                                {{event.date + ' ' + event.time | date:'shortTime'}} - 
                                                {{event.date + ' ' + event.end_time | date:'shortTime'}}
                                                ({{event.duration}})
                                            </span>
                                        </div>
                                    </div>
                                    <div class="bg-purple-100 px-3 py-1 rounded-full text-purple-600 text-sm">
                                        {{event.status}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="border-t px-6 py-4 flex justify-end">
                        <button (click)="closeUpcomingEventsModal()" 
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded">
                            Close
                        </button>
                    </div>
                </div>
            </div>


            <!-- PREVIOUS FORMAT -->
           <!-- Modal for completed events -->
<div *ngIf="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="border-b px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-semibold">Completed Events</h2>
            <button (click)="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6">
            <div class="grid gap-4">
                <div *ngFor="let event of completedEvents" 
                     class="bg-white rounded-lg border p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center gap-4">
                        <img [src]="event.image" 
                             [alt]="event.title"
                             class="w-16 h-16 object-cover rounded">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">{{event.title}}</h3>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fa-regular fa-calendar"></i>
                                <span>{{event.date | date:'mediumDate'}}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fa-regular fa-clock"></i>
                                <span>
                                    {{event.date + ' ' + event.time | date:'shortTime'}} - 
                                    {{event.date + ' ' + event.end_time | date:'shortTime'}}
                                    ({{event.duration}})
                                </span>
                            </div>
                        </div>
                        <div class="bg-purple-100 px-3 py-1 rounded-full text-purple-600 text-sm">
                            {{event.status}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="border-t px-6 py-4 flex justify-end">
            <button (click)="closeModal()" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded">
                Close
            </button>
        </div>
    </div>
</div>